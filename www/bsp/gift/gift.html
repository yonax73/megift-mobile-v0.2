<!DOCTYPE html>
<html>
<head>
    <title>Megift App Detail Gift</title>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link href="../../public/css/inventor/animations.min.css" rel="stylesheet" />
    <link href="../../public/materialize/css/materialize.min.css" rel="stylesheet" />
    <link href="../../public/css/app.min.css" rel="stylesheet" />
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>


</head>

<body class="i-ease-in i-1s i-fade-in flow-text grey lighten-2">
    <div class="TOP_TOOLBAR">
        <div class="navbar-fixed">
            <nav class="megift-bg" role="navigation">
                <div class="nav-wrapper container">
                    <a href="#" class="brand-logo brand-logo-s truncate">
                        Información de tu regalo
                    </a>
                    <a href="#" onclick="navBack()" rel="external" data-activates="nav-mobile" class="button-collapse">
                        <i class="mdi-hardware-keyboard-backspace"></i>
                    </a>
                </div>
            </nav>
        </div>
    </div>
    <div id="page" class="SCROLLER_FRAME">
        <div class="SCROLLER">
            <section id="loader">
                <img src="../../public/images/loaders/oval.svg" width="40" alt="cargando.." class="image-loader" />
            </section>
            <section id="content" class="hidden  m-top-1rem">
                <div class="row">
                    <div class="col s12 m12">
                        <div class="card">
                            <div class="card-content">
                                <p id="gift-name">
                                    <span class="progress">
                                        <span class="indeterminate"></span>
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col s12 m12">
                        <div class="card">
                            <div class="card-image">
                                <img id="gift-picture" src="../../public/images/preloader.gif" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col s12 m12">
                        <div class="card">
                            <div class="card-content">
                                <p>
                                    <i class="mdi-action-wallet-giftcard">&nbsp;</i>
                                    <span id="type-gift"></span>
                                </p>
                                <p>
                                    <i class="mdi-maps-local-atm">&nbsp;</i>
                                    <s id="gift-price"></s>
                                    <span class="green-text">&nbsp;$0</span>
                                </p>
                                <p>
                                    <i class="mdi-device-access-time">&nbsp;</i>
                                    <span id="gift-time"></span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col s12 m12">
                        <div class="card">
                            <div class="card-content">
                                <h5>
                                    Descripción
                                </h5>
                                <p id="gift-description" class="text-justify"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col s12 m12">
                        <div class="card">
                            <div class="card-content">
                                <h5>
                                    ¿Que debes hacer para
                                    disfrutar tu regalo?
                                </h5>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="invite-friend-content-2" class="hidden">
                    <div id="preloader" class="progress-deep-orange progress hidden">
                        <div class="progress-deep-orange indeterminate"></div>
                    </div>
                    <div class="row">
                        <div class="col s12 m12">
                            <div class="card">
                                <div class="card-content">
                                    <p>
                                        ¿te gusto este regalo?<br /><br />
                                        Estas a un paso de conocer que debes hacer para recibirlo.<br /><br />
                                        Para desbloquear esta información en todos los regalos,
                                        debes ayudarnos a encontrar mas personas que podamos hacer felices.<br /><br />
                                        Apoyanos invitando dos amigos a conocer Megift.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12 m12">
                            <div class="card">
                                <div class="card-content">
                                    <div class="row">
                                        <div class="col s12 m12">
                                            <h5>
                                                Cuentale a dos amigos
                                            </h5>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <form id="invite-friends-form" class="col s12">
                                            <div class="row">
                                                <div class="col s12">
                                                    <input id="email-friend-1" name="email-friend-1" type="text" class="input-flat validate" placeholder="Correo Electrónico">
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col s12">
                                                    <input id="email-friend-2" name="email-friend-2" type="text" class="input-flat validate" placeholder="Correo Electrónico">
                                                </div>
                                            </div>
                                            <input type="hidden" name="login-id" id="login-id" value="0" />
                                            <div class="row">
                                                <div class="col s12">
                                                    <button id="submit-form" class="btn btn-flat btn-fluid btn-large btn-megift-green" type="submit">
                                                        Enviar mensaje
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="row">
                                        <div class="col s12 m12">
                                            <p>
                                                Ó comparte con tus amigos
                                            </p>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col s12 m12">
                                            <button class="btn btn-flat btn-fluid btn-large btn-megift-red" onclick="socialMediaShare(true)">
                                                Compartir
                                                <i class="mdi-social-share">
                                                    &nbsp;
                                                </i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="data-gift-content">
                    <div class="row">
                        <div class="col s12 m12">
                            <div class="card">
                                <div class="card-content">
                                    <p id="action-name"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12 m12">
                            <div class="card">
                                <div class="card-image">
                                    <img id="action-picture" />
                                </div>
                            </div>
                        </div>
                        <div class="col s12 m12">
                            <div class="card">
                                <div class="card-content">
                                    <p>
                                        <i class="mdi-action-loyalty">&nbsp;</i>
                                        <span id="action-price"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12 m12">
                            <div class="card">
                                <div class="card-content">
                                    <h5>
                                        Descripción de la acción
                                    </h5>
                                    <p id="action-description" class="text-justify"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12 m12">
                            <div class="card">
                                <div class="card-content">
                                    <h5>
                                        Terminos y condiciones
                                    </h5>
                                    <p id="terms-conditions-gift" class="text-justify"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12 m12">
                            <div class="card">
                                <div class="card-content">
                                    <h5>
                                        Datos de contacto
                                    </h5>
                                    <p>
                                        <i class="mdi-action-assignment">&nbsp;</i>
                                        <span id="pos-name"></span>
                                    </p>
                                    <p>
                                        <i class="mdi-communication-phone">&nbsp;</i>
                                        <span id="pos-mb-phone"></span>
                                        <span id="pos-phone" class="hidden"></span>
                                    </p>
                                    <p>
                                        <i class="mdi-communication-email">&nbsp;</i>
                                        <span id="pos-email-contact"></span>
                                    </p>
                                    <p>
                                        <i class="mdi-social-public">&nbsp;</i>
                                        <a id="pos-web-site" href="#"></a>
                                    </p>
                                    <p>
                                        <i class="mdi-maps-directions-car">&nbsp;</i>
                                        <span id="pos-distance"></span>
                                    </p>
                                    <p>
                                        <i class="mdi-maps-place">&nbsp;</i>
                                        <span id="pos-address"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12 m12">
                            <div class="card">
                                <div class="card-content">
                                    <div id="map" class="map">
                                        <span class="progress">
                                            <span class="indeterminate"></span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12 m12">
                            <div class="card">
                                <div class="card-content">
                                    <a link="business-link" href="business.html" rel="external" class="link-highlight">
                                        <i class="mdi-action-wallet-giftcard">&nbsp;</i>
                                        <span>
                                            otros regalos de
                                            <span id="business-name-2"></span>
                                        </span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12 m12">
                            <div class="card">
                                <div class="card-content">
                                    <h6 class="white-text">
                                        comparte este regalo con tus amigos
                                    </h6>
                                    <div class="row">
                                        <div class="col s12 m12">
                                            <button class="btn btn-flat btn-fluid btn-large btn-megift-red" onclick="socialMediaShare(false)">
                                                Compartir
                                                <i class="mdi-social-share">
                                                    &nbsp;
                                                </i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
    <!-- Modal error -->
    <div id="modal-error" class="modal modal-fixed-footer">
        <div class="modal-content">
            <h4>Error!</h4>
            <p><strong id="error-msg"></strong>. intentalo nuevamente!</p>
            <p>Si el error persiste puedes contactarnos a <span class="red-500-text"><strong>soporte@megift.co</strong></span></p>
        </div>
        <div class="modal-footer">
            <a href="#" class="btn waves-effect waves-green btn-flat modal-action modal-close">Aceptar</a>
        </div>
    </div>
    <!-- Modal success -->
    <div id="modal-success" class="modal modal-fixed-footer">
        <div class="modal-content">
            <p>
                El mensaje ha sido enviado.<br /><br />
                Gracias por darnos la oportunidad de hacer a tus amigos felices.
            </p>
            <h5>¡En hora buena! ¡ya puedes ver como recibir el regalo.!</h5>
        </div>
        <div class="modal-footer">
            <a href="gift.html" class="btn waves-effect waves-green btn-flat modal-action">Recibir regalo</a>
        </div>
    </div>
    <script src="../../intelxdk.js"></script>
    <script src="../../cordova.js"></script>
    <script src="../../xhr.js"></script>
    <script src="../../public/js/jquery.min.js"></script>
    <script src="../../public/materialize/js/materialize.min.js"></script>
    <script src="../../public/js/inventor/BaseForm.min.js"></script>
    <script src="../../public/js/inventor/Animation.min.js"></script>
    <script src="../../public/js/app.min.js"></script>

    <script>
        var idLogin = window.localStorage.getItem('id-login');
        var host = window.localStorage.getItem('host');
        var posId = window.localStorage.getItem('pos-id');
        var giftId = window.localStorage.getItem('gift-id');
        var userLat = window.localStorage.getItem('latitude');
        var userLng = window.localStorage.getItem('longitude');
        var successResponse = 'OK';
        var latitude = null;
        var longitude = null;
        var tradeName = null;
        /*
        * device onready
        */
        function onDeviceReady() {
            init();
        }
        document.addEventListener('deviceready', onDeviceReady, false);
        init();
        //function init
        function init() {
            //validar si el regalo esta bloquead
            giftBlock();
            //loas gift
            loadGift();
        }
        /*
        * load gift
        */
        function loadGift() {
            $.ajax({
                type: 'GET',
                url: host + '/loadGiftForMobile?idPOS=' + posId + '&idGift=' + giftId + '&lat=' + userLat + '&lng=' + userLng,
                success: function (response) {
                    try {
                        var business = JSON.parse(response);
                        var pos = business.pos;
                        var gift = pos.gift;
                        var action = gift.action;
                        latitude = pos.location.address.geolocation.latitude;
                        longitude = pos.location.address.geolocation.longitude;
                        tradeName = business.tradeName;
                        window.localStorage.setItem('business-id', business.id);
                        document.getElementById('gift-name').textContent = gift.name;
                        var n = gift.pictures.length;
                        var i = 0;
                        var found = false;
                        var src = null;
                        if (n > 0) {
                            do {
                                var pic = gift.pictures[i];
                                found = pic.main;
                                if (found) {
                                    src = pic.dataURI;
                                }
                                i++;
                            } while (!found && i < n);
                        }
                        if (found) {
                            document.getElementById('gift-picture').src = src;
                        }
                        if (gift.type.id === 24) {//other type
                            document.getElementById('type-gift').textContent = gift.otheType;
                        } else {
                            document.getElementById('type-gift').textContent = gift.type.value1;
                        }
                        document.getElementById('gift-price').textContent = gift.priceFormatted;
                        document.getElementById('gift-time').textContent = gift.elapseTime;
                        document.getElementById('gift-description').textContent = gift.description;
                        document.getElementById('action-name').textContent = action.name;
                        n = action.pictures.length;
                        i = 0;
                        found = false;
                        src = '../../public/images/action149x150.png';
                        if (n > 0) {
                            do {
                                var pic = action.pictures[i];
                                found = pic.main;
                                if (found) {
                                    src = pic.dataURI;
                                }
                                i++;
                            } while (!found && i < n);
                        }
                        document.getElementById('action-picture').src = src;
                        document.getElementById('action-price').textContent = action.priceFormatted;
                        document.getElementById('action-description').textContent = action.description;
                        document.getElementById('terms-conditions-gift').textContent = gift.termsConditions;
                        document.getElementById('pos-name').textContent = pos.name;
                        document.getElementById('pos-mb-phone').textContent = pos.location.phone.mobile;
                        document.getElementById('pos-phone').textContent = pos.location.phone.number;
                        document.getElementById('pos-email-contact').textContent = pos.email;
                        var webSite = document.getElementById('pos-web-site');
                        webSite.textContent = pos.webSite == null ? 'No Disponible' : pos.webSite;
                        webSite.href = '#';
                        if (pos.webSite != null) {
                            webSite.onclick = function () {
                                openBusinessUrl(pos.webSite);
                            }
                        }
                        document.getElementById('pos-distance').textContent = pos.distanceFormatted;
                        document.getElementById('pos-address').textContent = pos.location.address.address;
                        document.getElementById('business-name-2').textContent = tradeName;
                        countDown(document.getElementById('gift-time'));
                        loaderOff();
                        initializeMap();
                    } catch (ex) {
                        toast(response, 2000, 'toast-danger');
                    }
                },
                error: function (xhr) {
                    document.getElementById('error-msg').textContent = xhr.statusText;
                    $('#modal-error').openModal();
                },
                timeout: 60000
            });
        }

        //init map
        function initializeMap() {
            var latlng = new google.maps.LatLng(latitude, longitude);
            var myOptions = {
                zoom: 16,
                center: latlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                disableDefaultUI: true
            };
            var map = new google.maps.Map(document.getElementById("map"), myOptions);
            // To add the marker to the map, use the 'map' property
            var marker = new google.maps.Marker({
                position: latlng,
                map: map,
                title: tradeName,
                icon: '../../public/images/gift-shop64.png'
            });
        }
        /*
        * gift block
        */
        function giftBlock() {
            var isBlocked = window.localStorage.getItem('block-gift');
            if ((isBlocked !== 'undefined' || isBlocked !== undefined) && isBlocked > 0) {
                document.getElementById('invite-friend-content-2').classList.remove('hidden');
                document.getElementById('data-gift-content').classList.add('hidden');
            }
        }

        /*
        * submit form
        */
        $('#invite-friends-form').submit(function (e) {
            e.preventDefault();
            var result1 = false;
            //valid email friend 1
            var friend1 = document.getElementById('email-friend-1');
            if (BaseForm.isEmail(friend1.value)) {
                if (friend1.classList.contains('invalid')) {
                    friend1.classList.remove('invalid');
                    friend1.classList.add('valid');
                }
                result1 = true;
            } else {
                if (!friend1.classList.contains('invalid')) {
                    friend1.classList.remove('valid');
                    friend1.classList.add('invalid');
                }
                toast('Ingrese un correo válido!', 2000, 'toast-danger');
                result1 = false;
            }
            //valid email friend 2
            var result2 = false;
            var friend2 = document.getElementById('email-friend-2');
            if (BaseForm.isEmail(friend1.value)) {
                if (friend2.classList.contains('invalid')) {
                    friend2.classList.remove('invalid');
                    friend2.classList.add('valid');
                }
                result2 = true;
            } else {
                if (!friend2.classList.contains('invalid')) {
                    friend2.classList.remove('valid');
                    friend2.classList.add('invalid');
                }
                toast('Ingrese un correo válido!', 2000, 'toast-danger');
                result2 = false;
            }
            if (result1 || result2) {
                //fill data
                document.getElementById('login-id').value = window.localStorage.getItem('id-login');
                //send form
                $.ajax({
                    type: 'POST',
                    url: host + '/inviteFriends',
                    data: $('#invite-friends-form').serialize(),
                    beforeSend: function () {
                        showPreloader();
                        disabledFormControls();
                    },
                    success: function (response) {
                        enabledFormControls();
                        hiddenPreloader();
                        enabledFormControls();
                        if (response === successResponse) {
                            //desbloquear regalo
                            window.localStorage.setItem('block-gift', 0);
                            window.location = '../../social/invite-friends-success-2.html';
                        } else {
                            toast(response, 4000, 'toast-danger');
                        }
                    },
                    error: function (xhr) {
                        hiddenPreloader();
                        enabledFormControls();
                        document.getElementById('error-msg').textContent = xhr.statusTexts;
                        $('#modal-error').openModal();
                    },
                    timeout: 60000
                });
            }
        });
        /*
        * Loader Off
        */
        function loaderOff() {
            var animationClose = new Animation('i-ease', 'i-fade-out', 'i-0-5s', 500);
            var loader = document.getElementById('loader');
            var content = document.getElementById('content');
            animationClose.run(loader, function () {
                loader.classList.add('hidden');
                content.classList.remove('hidden');
            });
        }
        /*
        * Mostrar preloader
        */
        function showPreloader() {
            var preloader = document.getElementById('preloader');
            if (preloader.classList.contains('hidden')) {
                preloader.classList.remove('hidden');
            }
        }
        /*
        * Esconder preloader
        */
        function hiddenPreloader() {
            var preloader = document.getElementById('preloader');
            if (!preloader.classList.contains('hidden')) {
                preloader.classList.add('hidden');
            }
        }
        /*
        * disbled Form Controls
        */
        function disabledFormControls() {
            var submitFormBtn = document.getElementById('submit-form');
            submitFormBtn.disabled = true;
        }
        /*
        * Enabled Form Controls
        */
        function enabledFormControls() {
            var submitFormBtn = document.getElementById('submit-form');
            submitFormBtn.disabled = false;
        }
        /*
        * Count down
        */
        function countDown(element) {
            window.setInterval(function () {
                var str = element.innerHTML;
                var token = str.split(':');
                var h = parseInt(token[0]);
                var m = parseInt(token[1]);
                var s = parseInt(token[2]);
                if (s < 1) {
                    s = 60;
                    m--;
                    if (m < 1) {
                        h--;
                    }
                }
                s--;
                element.innerHTML = formatTime(h) + ':' + formatTime(m) + ':' + formatTime(s);
            }, 1000);
        }
        /*
        * format time
        */
        function formatTime(time) {
            if (time < 10) {
                return '0' + time;
            }
            return time;
        }
        /*
        * Social media share
        */
        function socialMediaShare(isUnBlock) {
            try {
                var message = 'He tenido la suerte de encontrar en mi celular Megift, '
                    + 'una aplicación que me da regalos por hacer cosas divertidas como salir a comer, '
                    + 'comprar ropa, consentirme, y muchas más. Descárgala en el siguiente link';
                var subject = 'Tengo algo que contarte';
                window.plugins.socialsharing.share(message, subject, null, 'http://www.megift.co', function () {
                    if (isUnBlock) {
                        //desbloquear regalo
                        window.localStorage.setItem('block-gift', 0);
                        window.location = '../../social/invite-friends-success-2.html';
                    }
                }, function (msg) { alert('error: ' + msg) });
            } catch (ex) {
                alert(ex.message);
                console.error(ex);
            }
        }
        /*
        *open business url
        */
        function openBusinessUrl(url) {
            try {
                window.open(url, '_system', 'location=yes');
            } catch (ex) {
                alert(ex.message);
                console.error(ex);
            }
        }
        /*
        * Navigation Back
        */
        function navBack() {
            window.localStorage.setItem('gift-search-back', 1);
            window.location = window.localStorage.getItem('gift-back');
        }
    </script>
</body>
</html>
